from dotenv import load_dotenv
load_dotenv()

import streamlit as st
from datetime import datetime
import os
from api_claude import ChatAPI

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="AGI Chat Test",
    page_icon="ğŸ¤–",
    layout="wide"
)

# åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
if "messages" not in st.session_state:
    st.session_state.messages = []

if "logs" not in st.session_state:
    st.session_state.logs = []

# ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
if "api_key" not in st.session_state:
    st.session_state.api_key = os.getenv("API_KEY", "")

if "api_base" not in st.session_state:
    st.session_state.api_base = os.getenv("API_BASE", "")

# ä»ç¯å¢ƒå˜é‡è·å–é»˜è®¤æ¨¡å‹
if "selected_model" not in st.session_state:
    st.session_state.selected_model = os.getenv("DEFAULT_MODEL", "claude-3-5-sonnet-20240620")

# åˆå§‹åŒ– ChatAPI
if "chat_api" not in st.session_state:
    st.session_state.chat_api = None

def add_log(message: str, level: str = "INFO"):
    """æ·»åŠ æ—¥å¿—"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S.%f")[:-3]
    st.session_state.logs.append({
        "timestamp": timestamp,
        "level": level,
        "message": message
    })

# åˆ›å»ºä¸‰åˆ—å¸ƒå±€
left_column, main_column, right_column = st.columns([1, 2, 1])

# å·¦ä¾§æ ï¼ˆAPIè®¾ç½®ï¼‰
with left_column:
    st.sidebar.title("è®¾ç½®")
    
    # æ›´æ–°æ¨¡å‹é€‰æ‹©åˆ—è¡¨
    model_options = [
        "claude-3-5-sonnet-20240620",  # å°†é»˜è®¤æ¨¡å‹æ”¾åœ¨ç¬¬ä¸€ä½
        "gpt-3.5-turbo",
        "gpt-4",
        "claude-2",
        "claude-instant-1"
    ]
    
    selected_model = st.sidebar.selectbox(
        "é€‰æ‹©æ¨¡å‹",
        model_options,
        index=model_options.index(st.session_state.selected_model)
    )
    
    if selected_model != st.session_state.selected_model:
        st.session_state.selected_model = selected_model
        add_log(f"åˆ‡æ¢æ¨¡å‹åˆ°: {selected_model}", "INFO")
    
    # API è®¾ç½®
    api_base = st.sidebar.text_input(
        "API Base URL",
        value=st.session_state.api_base,
        help="è®¾ç½® API åŸºç¡€åœ°å€"
    )
    
    if st.session_state.api_key:
        st.sidebar.success("âœ… API Key å·²è®¾ç½®")
        if st.sidebar.button("æ¸…é™¤ API Key"):
            add_log("æ¸…é™¤ API Key", "INFO")
            st.session_state.api_key = ""
            st.experimental_rerun()
    else:
        api_key = st.sidebar.text_input("è¾“å…¥ API Key", type="password")
        if api_key:
            add_log("è®¾ç½®æ–°çš„ API Key", "INFO")
            st.session_state.api_key = api_key
            st.session_state.api_base = api_base
            add_log(f"è®¾ç½® API Base URL: {api_base}", "INFO")

# ä¸»èŠå¤©ç•Œé¢
with main_column:
    st.title("AGI Chat Test ğŸ¤–")
    
    # æ˜¾ç¤ºèŠå¤©å†å²
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ç”¨æˆ·è¾“å…¥
    if prompt := st.chat_input("åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æ¶ˆæ¯..."):
        if not st.session_state.api_key:
            st.error("è¯·å…ˆåœ¨ä¾§è¾¹æ è¾“å…¥ API Keyï¼")
            add_log("å°è¯•å‘é€æ¶ˆæ¯ä½†æœªè®¾ç½® API Key", "ERROR")
            st.stop()

        # ç¡®ä¿ ChatAPI å®ä¾‹å­˜åœ¨
        if st.session_state.chat_api is None:
            st.session_state.chat_api = ChatAPI(
                st.session_state.api_key,
                st.session_state.api_base,
                logger_callback=add_log
            )

        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        add_log(f"ç”¨æˆ·è¾“å…¥: {prompt}", "INFO")
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # æ˜¾ç¤ºåŠ©æ‰‹æ­£åœ¨è¾“å…¥çš„æç¤º
        with st.chat_message("assistant"):
            message_placeholder = st.empty()
            try:
                add_log("å¼€å§‹è°ƒç”¨ API", "INFO")
                response = st.session_state.chat_api.get_chat_response(
                    st.session_state.messages,
                    st.session_state.selected_model
                )
                
                if response.status_code == 200:
                    # å¤„ç†æµå¼å“åº”
                    full_response = st.session_state.chat_api.process_stream_response(
                        response,
                        message_placeholder.markdown
                    )
                    
                    add_log("API å“åº”å®Œæˆ", "INFO")
                    # ä¿å­˜åŠ©æ‰‹å›å¤
                    st.session_state.messages.append({"role": "assistant", "content": full_response})
                else:
                    error_msg = f"API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}"
                    add_log(error_msg, "ERROR")
                    st.error(error_msg)
                    
            except Exception as e:
                error_msg = str(e)
                add_log(f"API è°ƒç”¨é”™è¯¯: {error_msg}", "ERROR")
                st.error(f"å‘ç”Ÿé”™è¯¯: {error_msg}")

# å³ä¾§æ ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
with right_column:
    st.title("è°ƒè¯•ä¿¡æ¯")
    
    # æ˜¾ç¤ºå½“å‰çŠ¶æ€
    st.subheader("ç³»ç»ŸçŠ¶æ€")
    st.write(f"API Key çŠ¶æ€: {'å·²è®¾ç½®' if st.session_state.api_key else 'æœªè®¾ç½®'}")
    st.write(f"API Base URL: {st.session_state.api_base}")
    st.write(f"æ¶ˆæ¯æ•°é‡: {len(st.session_state.messages)}")
    
    # æ˜¾ç¤ºæ—¥å¿—
    st.subheader("è¿è¡Œæ—¥å¿—")
    for log in reversed(st.session_state.logs):
        color = {
            "INFO": "blue",
            "ERROR": "red",
            "WARNING": "orange"
        }.get(log["level"], "gray")
        
        st.markdown(f"""
        <div style="border-left: 2px solid {color}; padding-left: 10px; margin: 5px 0;">
            <small style="color: gray;">{log["timestamp"]}</small><br/>
            <span style="color: {color};">[{log["level"]}]</span> {log["message"]}
        </div>
        """, unsafe_allow_html=True)
    
    # æ¸…é™¤æ—¥å¿—æŒ‰é’®
    if st.button("æ¸…é™¤æ—¥å¿—"):
        st.session_state.logs = []
        st.experimental_rerun()



        import requests
import json
from typing import List, Dict, Any
from datetime import datetime

class ChatAPI:
    def __init__(self, api_key: str, api_base: str, logger_callback=None):
        self.api_key = api_key
        self.api_base = api_base
        self.logger_callback = logger_callback or (lambda *args, **kwargs: None)

    def _add_log(self, message: str, level: str = "INFO"):
        """è°ƒç”¨æ—¥å¿—å›è°ƒå‡½æ•°"""
        self.logger_callback(message, level)

    def get_chat_response(self, messages: List[Dict[str, str]], model: str) -> requests.Response:
        """å‘é€èŠå¤©è¯·æ±‚å¹¶è·å–å“åº”"""
        headers = {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0',
        }
        
        data = {
            "model": model,
            "messages": messages,
            "stream": True,
            "temperature": 0.7,
            "max_tokens": 1000
        }
        
        self._add_log(f"è¯·æ±‚å¤´: {json.dumps(headers, indent=2)}", "DEBUG")
        self._add_log(f"è¯·æ±‚ä½“: {json.dumps(data, indent=2)}", "DEBUG")
        
        try:
            response = requests.post(
                f'{self.api_base}/chat/completions',
                headers=headers,
                json=data,
                stream=True,
                timeout=30
            )
            
            self._add_log(f"å“åº”çŠ¶æ€ç : {response.status_code}", "DEBUG")
            if response.status_code != 200:
                self._add_log(f"å“åº”å†…å®¹: {response.text}", "ERROR")
                
            return response
            
        except requests.exceptions.RequestException as e:
            self._add_log(f"è¯·æ±‚å¼‚å¸¸: {str(e)}", "ERROR")
            raise

    def process_stream_response(self, response: requests.Response, message_callback) -> str:
        """å¤„ç†æµå¼å“åº”"""
        full_response = ""
        try:
            for line in response.iter_lines():
                if line:
                    line = line.decode('utf-8')
                    if line.startswith('data: '):
                        try:
                            json_str = line[6:]  # ç§»é™¤ "data: " å‰ç¼€
                            if json_str.strip() != "[DONE]":
                                chunk = json.loads(json_str)
                                if chunk['choices'][0]['delta'].get('content'):
                                    content = chunk['choices'][0]['delta']['content']
                                    full_response += content
                                    message_callback(full_response + "â–Œ")
                        except json.JSONDecodeError:
                            continue
            
            message_callback(full_response)
            return full_response
            
        except Exception as e:
            self._add_log(f"å¤„ç†å“åº”æµæ—¶å‡ºé”™: {str(e)}", "ERROR")
            raise 